import{d as dt,w as vt,R as w,k as W,S as pt,M as s,N as p,O as R,a0 as G,aG as J,T as tt,L as et,W as ft,r as h,Z as mt,J as _,$ as ht,U as gt,V as yt,p as wt,X as _t,a3 as S,v as bt,_ as kt}from"./index-COLuSNnH.js";/* empty css              *//* empty css              *//* empty css              */import{N as xt}from"./index-DtBFF6eJ.js";import{fetchNetValueHistoryFast as Ct}from"./fundFast-BTB3GdVE.js";import{u as Dt}from"./fund-qjlmdvOA.js";import{B as St}from"./index-dROw2vyl.js";import"./storage-BvZjhTaj.js";const Vt={class:"backtest-page"},Tt={class:"settings-section"},Ft={class:"field-value clickable"},Nt={key:0},Rt={key:1,class:"placeholder"},Mt={class:"field-item"},It={class:"mode-switch"},Bt={class:"field-item"},Lt={class:"field-label"},$t={class:"input-wrapper"},Pt={key:0,class:"field-item"},At={class:"mode-switch"},Wt={class:"field-item"},Ot={class:"field-item"},Ut={key:0,class:"result-section"},Ht={class:"result-header"},zt={class:"result-fund"},Yt={class:"metrics-grid"},jt={class:"metric-item"},Et={class:"metric-value"},Gt={class:"metric-item"},Jt={class:"metric-value"},Xt={class:"metric-item highlight"},Zt={class:"metric-item highlight"},qt={class:"metric-item"},Kt={class:"metric-value down"},Qt={class:"metric-item"},te={class:"metric-value"},ee={class:"metric-item"},se={class:"metric-value"},le={class:"chart-section"},ne={class:"search-popup"},oe={key:0,class:"empty-tip"},ae={key:1,class:"fund-list"},ie=["onClick"],re={class:"fund-name"},ce={class:"fund-code"},ue=dt({__name:"Backtest",setup(de){const st=ft(),lt=Dt(),V=h(""),O=h(""),D=h("lump"),U=h("10000"),T=h(""),F=h(""),M=h("monthly"),A=h(!1),X=wt(()=>lt.watchlist.map(l=>({code:l.code,name:l.name||l.code}))),d=h(null),H=h(!1),Z=h(null);vt(()=>d.value,l=>{l&&l.historyData.length>0&&bt(()=>nt(l.historyData))},{deep:!0});function nt(l){const t=Z.value;if(!t)return;const e=t.getContext("2d");if(!e)return;const i=t.getBoundingClientRect(),f=window.devicePixelRatio||1;t.width=i.width*f,t.height=i.height*f,e.scale(f,f);const u=i.width,n=i.height,o={top:20,right:15,bottom:30,left:60},b=u-o.left-o.right,r=n-o.top-o.bottom;e.clearRect(0,0,u,n);const k=l.map(a=>a.value),I=l.map(a=>a.invested),x=[...k,...I],N=Math.min(...x),B=Math.max(...x),g=B-N||1,L=document.documentElement.getAttribute("data-theme")==="dark",c=L?"rgba(255,255,255,0.5)":"rgba(0,0,0,0.5)",m=L?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.1)",C="#e4393c",$="#999";e.strokeStyle=m,e.lineWidth=1;for(let a=0;a<=4;a++){const v=o.top+r/4*a;e.beginPath(),e.moveTo(o.left,v),e.lineTo(u-o.right,v),e.stroke()}e.fillStyle=c,e.font="11px sans-serif",e.textAlign="right";for(let a=0;a<=4;a++){const v=B-g/4*a,y=o.top+r/4*a;e.fillText(v>=1e4?(v/1e4).toFixed(1)+"万":v.toFixed(0),o.left-5,y+4)}e.strokeStyle=$,e.lineWidth=1,e.setLineDash([4,4]),e.beginPath();for(let a=0;a<l.length;a++){const v=o.left+b/(l.length-1)*a,y=o.top+r-(l[a].invested-N)/g*r;a===0?e.moveTo(v,y):e.lineTo(v,y)}e.stroke(),e.setLineDash([]);const P=l[l.length-1].value,j=l[l.length-1].invested,E=P>=j;e.strokeStyle=E?C:"#1db82c",e.lineWidth=2,e.beginPath();for(let a=0;a<l.length;a++){const v=o.left+b/(l.length-1)*a,y=o.top+r-(l[a].value-N)/g*r;a===0?e.moveTo(v,y):e.lineTo(v,y)}e.stroke(),e.lineTo(o.left+b,o.top+r),e.lineTo(o.left,o.top+r),e.closePath(),e.fillStyle=E?"rgba(228, 57, 60, 0.1)":"rgba(29, 184, 44, 0.1)",e.fill(),e.fillStyle=c,e.textAlign="center";const K=Math.min(5,l.length);for(let a=0;a<K;a++){const v=Math.floor((l.length-1)*a/(K-1)),y=o.left+b/(l.length-1)*v,ct=l[v].date,Q=new Date(ct),ut=`${(Q.getMonth()+1).toString().padStart(2,"0")}/${Q.getDate().toString().padStart(2,"0")}`;e.fillText(ut,y,n-o.bottom+15)}e.font="10px sans-serif",e.textAlign="left",e.fillStyle=E?C:"#1db82c",e.fillRect(o.left,n-12,12,3),e.fillStyle=c,e.fillText("市值",o.left+16,n-8),e.fillStyle=$,e.setLineDash([4,4]),e.beginPath(),e.moveTo(o.left+50,n-10),e.lineTo(o.left+62,n-10),e.stroke(),e.setLineDash([]),e.fillStyle=c,e.fillText("投入",o.left+66,n-8)}function ot(l){V.value=l.code,O.value=l.name,A.value=!1}async function at(){if(!V.value){S("请选择基金");return}const l=parseFloat(U.value);if(isNaN(l)||l<=0){S("请输入有效的投资金额");return}if(!T.value||!F.value){S("请选择时间范围");return}if(new Date(T.value)>=new Date(F.value)){S("开始日期必须早于结束日期");return}H.value=!0;try{const t=await Ct(V.value,1100);if(t.length<10){S("历史数据不足");return}const e=new Date(T.value),i=new Date(F.value),u=[...t].reverse().filter(n=>{const o=new Date(n.date);return o>=e&&o<=i});if(u.length<2){S("所选时间范围数据不足");return}D.value==="lump"?d.value=it(u,l):d.value=rt(u,l,M.value)}catch(t){console.error("回测失败:",t),S("回测失败，请重试")}finally{H.value=!1}}function it(l,t){const e=l[0].netValue,i=l[l.length-1].netValue,f=t/e,u=f*i;let n=0,o=e;for(const r of l){r.netValue>o&&(o=r.netValue);const k=(o-r.netValue)/o*100;k>n&&(n=k)}const b=l.map(r=>({date:r.date,value:f*r.netValue,invested:t}));return{totalInvest:t,finalValue:u,profit:u-t,profitRate:(u-t)/t*100,maxDrawdown:n,tradeCount:1,avgCost:e,historyData:b}}function rt(l,t,e){const i=[];let f=-1,u=-1;for(const c of l){const m=new Date(c.date),C=m.getMonth(),$=Math.floor(m.getTime()/(10080*60*1e3));let P=!1;if(e==="monthly"&&C!==f?(P=!0,f=C):e==="weekly"&&$!==u&&(P=!0,u=$),P){const j=t/c.netValue;i.push({date:c.date,nav:c.netValue,amount:t,shares:j})}}if(i.length===0)return null;const n=i.reduce((c,m)=>c+m.amount,0),o=i.reduce((c,m)=>c+m.shares,0),b=n/o,r=l[l.length-1].netValue,k=o*r;let I=0,x=0,N=0,B=0,g=0;const L=[];for(const c of l){g<i.length&&i[g].date===c.date&&(N+=i[g].shares,B+=i[g].amount,g++);const m=N*c.netValue;if(L.push({date:c.date,value:m,invested:B}),m>x&&(x=m),x>0){const C=(x-m)/x*100;C>I&&(I=C)}}return{totalInvest:n,finalValue:k,profit:k-n,profitRate:(k-n)/n*100,maxDrawdown:I,tradeCount:i.length,avgCost:b,historyData:L}}function z(l){return l.toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})}const Y=new Date,q=new Date(Y);return q.setFullYear(Y.getFullYear()-1),T.value=q.toISOString().split("T")[0],F.value=Y.toISOString().split("T")[0],(l,t)=>{const e=xt,i=_t,f=St,u=mt;return _(),w("div",Vt,[W(e,{title:"回测模拟","left-arrow":"",onClickLeft:t[0]||(t[0]=n=>pt(st).back())}),s("div",Tt,[s("div",{class:"field-item",onClick:t[1]||(t[1]=n=>A.value=!0)},[t[10]||(t[10]=s("span",{class:"field-label"},"选择基金",-1)),s("div",Ft,[V.value?(_(),w("span",Nt,p(O.value||V.value),1)):(_(),w("span",Rt,"从自选中选择")),W(i,{name:"arrow",size:"14"})])]),s("div",Mt,[t[11]||(t[11]=s("span",{class:"field-label"},"投资模式",-1)),s("div",It,[s("span",{class:R(["mode-btn",{active:D.value==="lump"}]),onClick:t[2]||(t[2]=n=>D.value="lump")},"一次性买入",2),s("span",{class:R(["mode-btn",{active:D.value==="dip"}]),onClick:t[3]||(t[3]=n=>D.value="dip")},"定期定投",2)])]),s("div",Bt,[s("span",Lt,p(D.value==="lump"?"投资金额":"每期金额"),1),s("div",$t,[t[12]||(t[12]=s("span",{class:"input-prefix"},"¥",-1)),G(s("input",{"onUpdate:modelValue":t[4]||(t[4]=n=>U.value=n),type:"number",placeholder:"10000",class:"amount-input"},null,512),[[J,U.value]])])]),D.value==="dip"?(_(),w("div",Pt,[t[13]||(t[13]=s("span",{class:"field-label"},"定投频率",-1)),s("div",At,[s("span",{class:R(["mode-btn",{active:M.value==="monthly"}]),onClick:t[5]||(t[5]=n=>M.value="monthly")},"每月",2),s("span",{class:R(["mode-btn",{active:M.value==="weekly"}]),onClick:t[6]||(t[6]=n=>M.value="weekly")},"每周",2)])])):tt("",!0),s("div",Wt,[t[14]||(t[14]=s("span",{class:"field-label"},"开始日期",-1)),G(s("input",{"onUpdate:modelValue":t[7]||(t[7]=n=>T.value=n),type:"date",class:"date-input"},null,512),[[J,T.value]])]),s("div",Ot,[t[15]||(t[15]=s("span",{class:"field-label"},"结束日期",-1)),G(s("input",{"onUpdate:modelValue":t[8]||(t[8]=n=>F.value=n),type:"date",class:"date-input"},null,512),[[J,F.value]])]),W(f,{type:"primary",block:"",loading:H.value,onClick:at},{default:et(()=>[...t[16]||(t[16]=[ht(" 开始回测 ",-1)])]),_:1},8,["loading"])]),d.value?(_(),w("div",Ut,[s("div",Ht,[t[17]||(t[17]=s("span",{class:"result-title"},"回测结果",-1)),s("span",zt,p(O.value||V.value),1)]),s("div",Yt,[s("div",jt,[t[18]||(t[18]=s("span",{class:"metric-label"},"总投入",-1)),s("span",Et,"¥"+p(z(d.value.totalInvest)),1)]),s("div",Gt,[t[19]||(t[19]=s("span",{class:"metric-label"},"最终市值",-1)),s("span",Jt,"¥"+p(z(d.value.finalValue)),1)]),s("div",Xt,[t[20]||(t[20]=s("span",{class:"metric-label"},"收益金额",-1)),s("span",{class:R(["metric-value",d.value.profit>=0?"up":"down"])},p(d.value.profit>=0?"+":"")+"¥"+p(z(d.value.profit)),3)]),s("div",Zt,[t[21]||(t[21]=s("span",{class:"metric-label"},"收益率",-1)),s("span",{class:R(["metric-value",d.value.profitRate>=0?"up":"down"])},p(d.value.profitRate>=0?"+":"")+p(d.value.profitRate.toFixed(2))+"% ",3)]),s("div",qt,[t[22]||(t[22]=s("span",{class:"metric-label"},"最大回撤",-1)),s("span",Kt,"-"+p(d.value.maxDrawdown.toFixed(2))+"%",1)]),s("div",Qt,[t[23]||(t[23]=s("span",{class:"metric-label"},"交易次数",-1)),s("span",te,p(d.value.tradeCount)+"次",1)]),s("div",ee,[t[24]||(t[24]=s("span",{class:"metric-label"},"平均成本",-1)),s("span",se,p(d.value.avgCost.toFixed(4)),1)])]),s("div",le,[t[25]||(t[25]=s("div",{class:"chart-title"},"收益走势",-1)),s("canvas",{ref_key:"chartCanvas",ref:Z,class:"chart-canvas"},null,512)])])):tt("",!0),W(u,{show:A.value,"onUpdate:show":t[9]||(t[9]=n=>A.value=n),position:"bottom",style:{height:"60%"},round:""},{default:et(()=>[s("div",ne,[t[26]||(t[26]=s("div",{class:"popup-title"},"从自选中选择",-1)),X.value.length===0?(_(),w("div",oe," 暂无自选基金，请先添加 ")):(_(),w("div",ae,[(_(!0),w(gt,null,yt(X.value,n=>(_(),w("div",{key:n.code,class:"fund-item",onClick:o=>ot(n)},[s("span",re,p(n.name),1),s("span",ce,p(n.code),1)],8,ie))),128))]))])]),_:1},8,["show"])])}}}),be=kt(ue,[["__scopeId","data-v-f92d483b"]]);export{be as default};
