import{bc as f,bd as $,be as S,au as A}from"./index-COLuSNnH.js";function z(t){["estimate","netvalue","kline","period"].forEach(s=>{[30,60,90,180,365,400].forEach(e=>{f.delete(`${s}_${t}_${e}`)}),f.delete(`${s}_${t}`)})}function B(){f.clear()}const P=5;let b=0;const F=[];function R(){if(F.length>0&&b<P){const t=F.shift();t&&t()}}function M(t){return new Promise((r,s)=>{const e=async()=>{b++;try{const i=await t();r(i)}catch(i){s(i)}finally{b--,R()}};b<P?e():F.push(e)})}let _=[],k=!1;function K(){k||(k=!0,window.jsonpgz=t=>{if(!t||!t.fundcode)return;const r=_.findIndex(s=>s.code===t.fundcode);if(r!==-1){const s=_[r];clearTimeout(s.timeout),_.splice(r,1),s.resolve(t)}})}function j(t){const r=`estimate_${t}`,s=f.get(r);if(s)return Promise.resolve(s);const e=S.get(r);return!A()&&e?(f.set(r,e,$.ESTIMATE),Promise.resolve(e)):M(()=>new Promise((i,l)=>{K();const a=`fund_${t}_${Date.now()}`,d=setTimeout(()=>{n();const o=_.findIndex(u=>u.code===t);o!==-1&&_.splice(o,1),e?i(e):l(new Error(`超时: ${t}`))},8e3);_.push({code:t,resolve:o=>{f.set(r,o,$.ESTIMATE),S.set(r,o),i(o)},reject:o=>{e?i(e):l(o)},timeout:d});function n(){const o=document.getElementById(a);o&&document.body.removeChild(o)}const c=document.createElement("script");c.id=a,c.src=`https://fundgz.1234567.com.cn/js/${t}.js?rt=${Date.now()}`,c.onerror=()=>{n();const o=_.findIndex(u=>u.code===t);o!==-1&&(clearTimeout(_[o].timeout),_.splice(o,1)),e?i(e):l(new Error(`失败: ${t}`))},c.onload=()=>{setTimeout(n,100)},document.body.appendChild(c)}))}async function U(t){const r=new Map,s=t.map(async e=>{try{const i=await j(e);r.set(e,i)}catch{}});return await Promise.all(s),r}async function N(t,r=30){const s=`netvalue_${t}_${r}`,e=f.get(s);return e||new Promise(i=>{const l=`netvalue_${t}_${Date.now()}`,a=setTimeout(()=>{n(),i([])},15e3),d=document.createElement("script");d.id=l,d.src=`https://fund.eastmoney.com/pingzhongdata/${t}.js?v=${Date.now()}`,d.onload=()=>{n();try{const c=window.Data_netWorthTrend||[];if(c.length===0){i([]);return}const u=c.slice(-r).map(h=>{const m=new Date(h.x);return{date:`${m.getFullYear()}-${String(m.getMonth()+1).padStart(2,"0")}-${String(m.getDate()).padStart(2,"0")}`,netValue:h.y||0,totalNetValue:h.y||0,changeRate:h.equityReturn||0}});u.reverse(),f.set(s,u,$.NET_VALUE),i(u)}catch(c){console.error("解析历史净值失败:",c),i([])}},d.onerror=()=>{n(),i([])};function n(){clearTimeout(a);const c=document.getElementById(l);c&&document.body.removeChild(c)}document.body.appendChild(d)})}async function q(t,r=60){const s=`kline_${t}_${r}`,e=f.get(s);if(e)return e;const l=(await N(t,r)).map(a=>({time:a.date,value:a.netValue,change:a.changeRate})).reverse();return f.set(s,l,$.NET_VALUE),l}async function v(t){const r=`period_${t}`,s=f.get(r);if(s)return s;const e=await N(t,400);if(e.length<2)return[];const i=e[0];if(!i||i.netValue<=0)return[];const l=[],a=[{period:"Z",label:"近1周",days:7},{period:"Y",label:"近1月",days:30},{period:"3Y",label:"近3月",days:90},{period:"6Y",label:"近6月",days:180},{period:"1N",label:"近1年",days:365}];for(const d of a){const n=new Date;n.setDate(n.getDate()-d.days);let c=null;for(const o of e)if(new Date(o.date)<=n){c=o;break}if(c&&c.netValue>0){const o=(i.netValue-c.netValue)/c.netValue*100;l.push({period:d.period,label:d.label,days:d.days,change:parseFloat(o.toFixed(2))})}}return f.set(r,l,$.NET_VALUE),l}async function L(){const t="market_indices",r=f.get(t);if(r)return r;try{const i=await(await fetch("https://push2.eastmoney.com/api/qt/ulist.np/get?fltt=2&secids=1.000001,0.399001,0.399006,1.000300&fields=f2,f3,f4,f12,f14")).json();if(!i?.data?.diff)return[];const l=i.data.diff.map(a=>({code:a.f12,name:a.f14,current:a.f2,change:a.f4,changePercent:a.f3}));return f.set(t,l,$.MARKET_INDEX),l}catch{return[]}}async function O(t){const r=`manager_${t}`,s=f.get(r);return s||new Promise(e=>{const i=`manager_${t}_${Date.now()}`,l=setTimeout(()=>{d(),e(null)},15e3),a=document.createElement("script");a.id=i,a.src=`https://fund.eastmoney.com/pingzhongdata/${t}.js?v=${Date.now()}`,a.onload=()=>{d();try{const n=window.Data_currentFundManager||[];if(n.length===0){e(null);return}const c=n[0];let o="--";if(c.profit&&typeof c.profit=="object")try{const m=c.profit.series?.[0]?.data?.[0]?.y;m!=null&&(o=`${m.toFixed(2)}%`)}catch{o="--"}let u="";if(c.power?.categories&&c.power?.data){const m=c.power.categories.map((g,y)=>`${g}: ${c.power.data[y]?.toFixed?.(1)||c.power.data[y]||"--"}分`).join("、");u=`综合能力评分 ${c.power.avr||"--"}。${m}`}const h={name:c.name||"未知",photo:c.pic||"",workTime:c.workTime||"--",fundSize:c.fundSize||"--",bestReturn:o,experience:u,funds:[]};f.set(r,h,$.FUND_INFO),e(h)}catch(n){console.error("解析经理数据失败:",n),e(null)}},a.onerror=()=>{d(),e(null)};function d(){clearTimeout(l);const n=document.getElementById(i);n&&document.body.removeChild(n)}document.body.appendChild(a)})}async function Y(t=1,r=30){const s=`ranking_${t}_${r}`,e=f.get(s);if(e)return e;try{const i=`https://push2.eastmoney.com/api/qt/clist/get?pn=1&pz=${r}&po=${t}&np=1&fltt=2&invt=2&fid=f3&fs=b:MK0021&fields=f2,f3,f4,f12,f14&_=${Date.now()}`,a=await(await fetch(i)).json();if(!a?.data?.diff)return[];const d=a.data.diff.map(n=>({code:n.f12,name:n.f14,netValue:n.f2||0,dayChange:n.f3||0}));return f.set(s,d,3e4),d}catch(i){return console.error("获取基金排行失败:",i),[]}}async function H(t){const r=`manager_profit_${t}`,s=f.get(r);return s||new Promise(e=>{const i=`mprofit_${t}_${Date.now()}`,l=setTimeout(()=>{d(),e([])},1e4),a=document.createElement("script");a.id=i,a.src=`https://fund.eastmoney.com/pingzhongdata/${t}.js?v=${Date.now()}`,a.onload=()=>{d();try{const n=window.Data_grandTotal||[];if(!Array.isArray(n)||n.length===0){e([]);return}const c=Math.max(1,Math.floor(n.length/200)),o=[];for(let m=0;m<n.length;m+=c){const g=n[m];if(Array.isArray(g)&&g.length>=2){const y=new Date(g[0]);o.push({date:`${y.getFullYear()}-${String(y.getMonth()+1).padStart(2,"0")}-${String(y.getDate()).padStart(2,"0")}`,profit:g[1]||0})}}const u=n[n.length-1],h=o[o.length-1];if(u&&h&&h.date!==new Date(u[0]).toISOString().split("T")[0]){const m=new Date(u[0]);o.push({date:`${m.getFullYear()}-${String(m.getMonth()+1).padStart(2,"0")}-${String(m.getDate()).padStart(2,"0")}`,profit:u[1]||0})}f.set(r,o,$.NET_VALUE),e(o)}catch{e([])}},a.onerror=()=>{d(),e([])};function d(){clearTimeout(l);const n=document.getElementById(i);n&&document.body.removeChild(n)}document.body.appendChild(a)})}async function X(){const t="global_indices",r=f.get(t);if(r)return r;const s=[{code:"1.000001",name:"上证指数",region:"cn"},{code:"0.399001",name:"深证成指",region:"cn"},{code:"0.399006",name:"创业板指",region:"cn"},{code:"100.HSI",name:"恒生指数",region:"hk"},{code:"100.DJIA",name:"道琼斯",region:"us"},{code:"100.NDX",name:"纳斯达克",region:"us"},{code:"100.SPX",name:"标普500",region:"us"},{code:"100.N225",name:"日经225",region:"asia"}],e=[];try{const i=s.map(a=>a.code).join(","),l=`globalIdx_${Date.now()}`;return await new Promise(a=>{const d=setTimeout(()=>{c(),a()},8e3);window[l]=o=>{c();try{o?.data?.diff&&o.data.diff.forEach((u,h)=>{s[h]&&u.f2>0&&e.push({name:s[h].name,code:s[h].code,price:u.f2/100,change:u.f4/100,changePercent:u.f3/100,region:s[h].region})})}catch{}a()};const n=document.createElement("script");n.id=l,n.src=`https://push2.eastmoney.com/api/qt/ulist.np/get?secids=${i}&fields=f2,f3,f4,f12,f14&cb=${l}&_=${Date.now()}`,n.onerror=()=>{c(),a()};function c(){clearTimeout(d);const o=document.getElementById(l);o&&document.body.removeChild(o);try{delete window[l]}catch{}}document.body.appendChild(n)}),e.length===0?x():(f.set(t,e,$.MARKET_INDEX),e)}catch{return x()}}function x(){return[{name:"上证指数",code:"s_sh000001",price:0,change:0,changePercent:0,region:"cn"},{name:"深证成指",code:"s_sz399001",price:0,change:0,changePercent:0,region:"cn"},{name:"恒生指数",code:"rt_hkHSI",price:0,change:0,changePercent:0,region:"hk"},{name:"道琼斯",code:"gb_$dji",price:0,change:0,changePercent:0,region:"us"},{name:"纳斯达克",code:"gb_$ixic",price:0,change:0,changePercent:0,region:"us"},{name:"日经225",code:"int_nikkei",price:0,change:0,changePercent:0,region:"asia"}]}const C=["#3b82f6","#ef4444","#22c55e","#f59e0b","#8b5cf6","#ec4899","#06b6d4","#84cc16","#f97316","#6366f1"];async function G(t){const r=`industry_${t}`,s=f.get(r);return s||new Promise(e=>{const i=`industry_${t}_${Date.now()}`,l=setTimeout(()=>{d(),e([])},1e4),a=document.createElement("script");a.id=i,a.src=`https://fund.eastmoney.com/pingzhongdata/${t}.js?v=${Date.now()}`,a.onload=()=>{d();try{const n=window.Data_IndustryAllocation;if(!n?.series?.[0]?.data){e([]);return}const c=n.series[0].data.filter(o=>o.y>0).slice(0,10).map((o,u)=>({name:o.name||"其他",ratio:parseFloat(o.y?.toFixed(2))||0,color:C[u%C.length]}));f.set(r,c,$.FUND_INFO),e(c)}catch{e([])}},a.onerror=()=>{d(),e([])};function d(){clearTimeout(l);const n=document.getElementById(i);n&&document.body.removeChild(n)}document.body.appendChild(a)})}async function J(t){const r=`asset_${t}`,s=f.get(r);return s||new Promise(e=>{const i=`asset_${t}_${Date.now()}`,l=setTimeout(()=>{d(),e(null)},1e4),a=document.createElement("script");a.id=i,a.src=`https://fund.eastmoney.com/pingzhongdata/${t}.js?v=${Date.now()}`,a.onload=()=>{d();try{const n=window.Data_assetAllocation;if(!n?.series){e(null);return}const c=u=>{const h=n.series.find(m=>m.name===u);return h?.data?.length&&h.data[h.data.length-1]||0},o={stock:parseFloat(c("股票占净比").toFixed(2)),bond:parseFloat(c("债券占净比").toFixed(2)),cash:parseFloat(c("现金占净比").toFixed(2)),other:parseFloat(c("其他占净比").toFixed(2))};f.set(r,o,$.FUND_INFO),e(o)}catch{e(null)}},a.onerror=()=>{d(),e(null)};function d(){clearTimeout(l);const n=document.getElementById(i);n&&document.body.removeChild(n)}document.body.appendChild(a)})}async function Q(t){const r=`rating_${t}`,s=f.get(r);return s||new Promise(e=>{const i=`rating_${t}_${Date.now()}`,l=setTimeout(()=>{d(),e(null)},1e4),a=document.createElement("script");a.id=i,a.src=`https://fund.eastmoney.com/pingzhongdata/${t}.js?v=${Date.now()}`,a.onload=()=>{d();try{const n=window.Data_rateInSimilarType||[],c=window.Data_rateInSimilarPers498||[],o=window.Data_fluctuationScale||{};let u=3;if(n.length>0){const p=n[n.length-1];if(p){const w=p.rank/p.total*100;w<=20?u=5:w<=40?u=4:w<=60?u=3:w<=80?u=2:u=1}}let h=0,m=0,g=0;if(o?.series){const p=o.series.find(D=>D.name?.includes("夏普"));p?.data?.length&&(h=p.data[p.data.length-1]||0);const w=o.series.find(D=>D.name?.includes("标准差")||D.name?.includes("波动"));w?.data?.length&&(g=w.data[w.data.length-1]||0)}if(c.length>0){const p=c.map(T=>T.y||T),w=Math.max(...p),D=Math.min(...p);m=w>0?(w-D)/w*100:0}let y="中风险";g<10?y="低风险":g<20?y="中低风险":g<30?y="中风险":g<40?y="中高风险":y="高风险";let I="--";if(n.length>0){const p=n[n.length-1];p&&p.rank!==void 0&&p.total!==void 0&&(I=`${p.rank}/${p.total}`)}const E={rating:u,riskLevel:y,sharpeRatio:parseFloat(h.toFixed(2)),maxDrawdown:parseFloat(m.toFixed(2)),volatility:parseFloat(g.toFixed(2)),rankInSimilar:I};f.set(r,E,$.FUND_INFO),e(E)}catch{e(null)}},a.onerror=()=>{d(),e(null)};function d(){clearTimeout(l);const n=document.getElementById(i);n&&document.body.removeChild(n)}document.body.appendChild(a)})}export{v as calculatePeriodReturns,B as clearAllCache,z as clearFundCache,J as fetchAssetAllocation,j as fetchFundEstimateFast,U as fetchFundEstimatesBatch,O as fetchFundManagerInfo,Y as fetchFundRankingFast,Q as fetchFundRating,X as fetchGlobalIndices,G as fetchIndustryAllocation,H as fetchManagerProfit,L as fetchMarketIndicesFast,N as fetchNetValueHistoryFast,q as fetchSimpleKLineData};
