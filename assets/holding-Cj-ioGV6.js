import{I as z,r as h,p as F}from"./index-COLuSNnH.js";import{g as I,u as S,r as k}from"./storage-BvZjhTaj.js";import{fetchFundEstimateFast as N}from"./fundFast-BTB3GdVE.js";import{calculateDailyServiceFee as H}from"./fund-BsJItZTy.js";const U=z("holding",()=>{const o=h([]),c=h(!1),D=F(()=>{let t=0,e=0,n=0;o.value.forEach(s=>{s.marketValue!==void 0&&(t+=s.marketValue),e+=s.amount,s.todayProfit!==void 0&&(n+=s.todayProfit)});const a=t-e,i=e>0?a/e*100:0;return{totalValue:t,totalCost:e,totalProfit:a,totalProfitRate:i,todayProfit:n}}),v=F(()=>o.value.map(t=>t.code));function C(){const t=I();o.value=t.map(e=>({...e,loading:!0})),t.length>0&&d()}async function d(){if(o.value.length===0){c.value=!1;return}c.value=!0;const t=o.value.map(e=>e.code);try{(await Promise.all(t.map(n=>N(n).catch(()=>null)))).forEach((n,a)=>{if(n)V(t[a],n);else{const i=o.value.find(s=>s.code===t[a]);i&&(i.loading=!1)}})}finally{c.value=!1}}function V(t,e){const n=o.value.findIndex(u=>u.code===t);if(n===-1)return;const a=o.value[n],i=parseFloat(e.gsz)||0,s=parseFloat(e.dwjz)||0,r=i>0?i:s;if(r<=0){o.value[n]={...a,name:e.name||a.name,loading:!1};return}let l=a.shares;if(!l||l<=0){const u=a.buyNetValue>0?a.buyNetValue:r;l=a.amount/u}const g=l*r;let f=a.amount,m=0;if(a.shareClass==="C"&&a.serviceFeeRate){const u=a.holdingDays||0;u>0&&(m=H(l,r,a.serviceFeeRate)*u)}const y=g-f-m,w=f>0?y/f*100:0;let p=l*(r-s);if(a.shareClass==="C"&&a.serviceFeeRate){const u=H(l,r,a.serviceFeeRate);p-=u}o.value[n]={...a,name:e.name||a.name,currentValue:r,marketValue:g,profit:y,profitRate:w,todayChange:e.gszzl,todayProfit:p,loading:!1,shares:l,serviceFeeDeducted:a.shareClass==="C"?m:void 0}}async function P(t){S(t);const e=o.value.findIndex(n=>n.code===t.code);e>-1?o.value[e]={...o.value[e],...t}:o.value.push({...t,loading:!0}),await d()}function R(t){k(t);const e=o.value.findIndex(n=>n.code===t);e>-1&&o.value.splice(e,1)}function b(t){return v.value.includes(t)}function x(t){return o.value.find(e=>e.code===t)}function E(){const t=new Date;o.value.forEach(e=>{if(e.buyDate){const n=new Date(e.buyDate),a=t.getTime()-n.getTime(),i=Math.ceil(a/(1e3*60*60*24));e.holdingDays=i}})}return{holdings:o,isRefreshing:c,summary:D,holdingCodes:v,initHoldings:C,refreshEstimates:d,addOrUpdateHolding:P,removeHolding:R,hasHolding:b,getHoldingByCode:x,updateHoldingDays:E}});export{U as u};
